name: hosts

on: 
  schedule:
    - cron: "0 10 */3 * *"
     
  workflow_dispatch:
    inputs:
      dns:
        description: 'DNS'
        required: true
        default: 'Aliyun'
        type: choice
        options:
        - 'Google'
        - 'OpenDNS'
        - 'AT&T'
        - 'Aliyun'
        - 'LG'
        - 'IONICA'

jobs:
  hosts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Init Env
        run : |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          sudo timedatectl set-timezone "Asia/Shanghai"
          python -m pip install --upgrade pip setuptools
          python -m pip install urllib3
          
      - name: Get Github Hosts
        shell: python
        run: |
          import os, time, json, urllib3

          class GoogleDNSChecker():
              def __init__(self) -> None:
                  self.dnsServers = {
                      "Google": {
                          "url": "https://dns.google/resolve",
                          "provider": "Google Public DNS",
                          "location": "Mountain View CA, United States"
                      },
                      "Cloudflare": {
                          "url": "https://cloudflare-dns.com/dns-query",
                          "provider": "Cloudflare DNS",
                          "location": "San Francisco CA, United States"
                      },
                      "Aliyun": {
                          "url": "https://dns.alidns.com/resolve",
                          "provider": "Aliyun Computing Co. Ltd",
                          "location": "Hangzhou, China"
                      }
                  }
                  self.currentServer = 'Google'
                  self.PM = urllib3.PoolManager()
                  self.headers = {
                      'accept': 'application/dns-json'
                  }

              def setServers(self, servers=''):
                  # 兼容旧的服务器名称
                  server_mapping = {
                      'Google': 'Google',
                      'OpenDNS': 'Google',
                      'AT&T': 'Google',
                      'Aliyun': 'Aliyun',
                      'LG': 'Google',
                      'IONICA': 'Google'
                  }
                  if servers in server_mapping:
                      self.currentServer = server_mapping[servers]

              def getServers(self):
                  return self.dnsServers[self.currentServer]

              def check(self, qname='', rdtype='A', max_retries=3):
                  """查询域名的 IP 地址,支持重试"""
                  for attempt in range(max_retries):
                      try:
                          server_info = self.dnsServers[self.currentServer]
                          url = '{}?name={}&type={}'.format(server_info['url'], qname, rdtype)
                          
                          res = self.PM.request('GET', url, headers=self.headers, timeout=10.0)
                          
                          if res.status == 200:
                              data = json.loads(res.data.decode('utf-8'))
                              
                              if 'Answer' in data and len(data['Answer']) > 0:
                                  ips = []
                                  for answer in data['Answer']:
                                      if 'data' in answer and answer.get('type') == 1:  # A记录
                                          ips.append(answer['data'])
                                  
                                  if len(ips) > 0:
                                      print('[成功] {} -> {}'.format(qname, ips[0]))
                                      return True, ips
                          
                          # 如果没有获取到结果,等待后重试
                          if attempt < max_retries - 1:
                              time.sleep(1)
                              
                      except Exception as err:
                          print('[错误] {} 查询失败 (尝试 {}/{}): {}'.format(qname, attempt + 1, max_retries, err))
                          if attempt < max_retries - 1:
                              time.sleep(2)
                  
                  print('[失败] {} 无法解析'.format(qname))
                  return False, []


          if __name__ == '__main__':
              gitHubDoMains = [
                  "github.githubassets.com",
                  "central.github.com",
                  "desktop.githubusercontent.com",
                  "assets-cdn.github.com",
                  "camo.githubusercontent.com",
                  "github.map.fastly.net",
                  "github.global.ssl.fastly.net",
                  "gist.github.com",
                  "github.io",
                  "github.com",
                  "api.github.com",
                  "raw.githubusercontent.com",
                  "user-images.githubusercontent.com",
                  "favicons.githubusercontent.com",
                  "avatars5.githubusercontent.com",
                  "avatars4.githubusercontent.com",
                  "avatars3.githubusercontent.com",
                  "avatars2.githubusercontent.com",
                  "avatars1.githubusercontent.com",
                  "avatars0.githubusercontent.com",
                  "avatars.githubusercontent.com",
                  "codeload.github.com",
                  "github-cloud.s3.amazonaws.com",
                  "github-com.s3.amazonaws.com",
                  "github-production-release-asset-2e65be.s3.amazonaws.com",
                  "github-production-user-asset-6210df.s3.amazonaws.com",
                  "github-production-repository-file-5c1aeb.s3.amazonaws.com",
                  "githubstatus.com",
                  "github.community",
                  "media.githubusercontent.com",
                  "objects.githubusercontent.com",
                  "raw.github.com",
                  "copilot-proxy.githubusercontent.com"
              ]
              
              dockerDoMains = [
                  "hub.docker.com",
                  "ghcr.io",
                  "gcr.io",
                  "k8s.gcr.io",
                  "quay.io"
              ]
              
              tMMDoMains = [
                  "themoviedb.org",
                  "www.themoviedb.org",
                  "api.themoviedb.org",
                  "tmdb.org",
                  "api.tmdb.org",
                  "image.tmdb.org"
              ]
              
              dnsobj = GoogleDNSChecker()

              dnsservers = 'Aliyun'
              if '${{ inputs.dns }}' != '':
                  dnsservers = '${{ inputs.dns }}'
              dnsobj.setServers(dnsservers)

              print('=== 开始解析域名 ===')
              print('使用 DNS: {}'.format(dnsobj.getServers()['provider']))
              print('')

              dnsList = []
              dnsList.append('# ING Hosts Start')
              dnsList.append('# Raw Url: https://raw.githubusercontent.com/shidahuilang/hosts/main/hosts')
              dnsList.append('# CDN Url: https://gcore.jsdelivr.net/gh/shidahuilang/hosts@main/hosts')
              dnsList.append('# CDN Url: https://cdn.staticaly.com/gh/shidahuilang/hosts/main/hosts')
              dnsList.append('# DNS Servers: {}'.format(dnsobj.getServers()['provider']))
              dnsList.append('# Update at: {}'.format(time.strftime("%Y-%m-%d %H:%M:%S")))

              success_count = 0
              total_domains = len(gitHubDoMains) + len(dockerDoMains) + len(tMMDoMains)

              # GitHub
              print('--- 解析 GitHub 域名 ---')
              dnsList.append('# GitHub Hosts Start')
              for domain in gitHubDoMains:
                  ret, ips = dnsobj.check(domain, 'A')
                  if ret == True:
                      dnsList.append((ips[0].ljust(16) + domain))
                      success_count += 1
              dnsList.append('# GitHub Hosts End')
              print('')
              
              # Docker
              print('--- 解析 Docker 域名 ---')
              dnsList.append('# Docker Hosts Start')
              for domain in dockerDoMains:
                  ret, ips = dnsobj.check(domain, 'A')
                  if ret == True:
                      dnsList.append((ips[0].ljust(16) + domain))
                      success_count += 1
              dnsList.append('# Docker Hosts End')
              print('')
              
              # TMM
              print('--- 解析 TMM 域名 ---')
              dnsList.append('# TMM Hosts Start')
              for domain in tMMDoMains:
                  ret, ips = dnsobj.check(domain, 'A')
                  if ret == True:
                      dnsList.append((ips[0].ljust(16) + domain))
                      success_count += 1
              dnsList.append('# TMM Hosts End')
              
              dnsList.append('# ING Hosts End')
              
              print('')
              print('=== 解析完成 ===')
              print('成功: {}/{} 个域名'.format(success_count, total_domains))
              print('')

              # 验证解析成功率
              min_required = int(total_domains * 0.6)  # 至少成功 60%
              if success_count < min_required:
                  print('[致命错误] 解析成功的域名数量不足 ({}/{}),放弃提交!'.format(success_count, min_required))
                  print('可能原因: DNS 服务器无法访问或网络问题')
                  exit(1)
              
              with open('hosts', 'w', encoding="utf-8") as f:
                  f.writelines('\n'.join(dnsList))
              
              print('[完成] hosts 文件已生成')

      - name: Check and Push
        run: |
          if [ -n "$(git status -s | grep hosts)" ]; then
            git add hosts
            git commit -m "update $(date +%Y-%m-%d" "%H:%M:%S)"
            git push -f
          fi
